"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Obtain a session for tracking subscriptions
 *
 * @param semotus
 * @param {unknown} role unknown
 * @param {unknown} sendMessage unknown
 * @param {unknown} sessionId unknown
 *
 * @returns {*} unknown
 */
function create(semotus, role, sendMessage, sessionId) {
    if (!semotus.sessions) {
        semotus.nextSubscriptionId = 0;
        semotus.nextSessionId = 1;
        semotus.sessions = {};
    }
    if (!sessionId) {
        sessionId = semotus.nextSessionId++;
    }
    semotus.setSession(sessionId);
    semotus.sessions[sessionId] = {
        subscriptions: {},
        sendMessage: sendMessage,
        sendMessageEnabled: !!sendMessage,
        remoteCalls: [],
        pendingRemoteCalls: {},
        nextPendingRemoteCallId: 1,
        nextSaveSessionId: 1,
        savedSessionId: 0,
        nextSubscriptionId: 0,
        objects: {},
        nextObjId: 1,
        dispenseNextId: null // Force next object Id
    };
    if (role instanceof Array) {
        for (var ix = 0; ix < role.length; ++ix) {
            semotus.subscribe(role[ix]);
        }
        semotus.role = role[1];
    }
    else {
        semotus.subscribe(role);
        semotus.role = role;
    }
    return sessionId;
}
exports.create = create;
/**
 * Remove the session from the sessions map, rejecting any outstanding promises
 * WARNING: Async side effects
 * @param semotus
 * @param {unknown} sessionId unknown
 */
function remove(semotus, sessionId) {
    var session = get(semotus, sessionId);
    for (var calls in session.remoteCalls) {
        session.remoteCalls[calls].deferred.reject({ code: 'reset', text: 'Session resynchronized' });
    }
    if (semotus.sessions[sessionId]) {
        delete semotus.sessions[sessionId];
    }
}
exports.remove = remove;
/**
 * Get the current session structure
 *
 * @returns {*} the session
 *
 * @private
 */
function get(semotus, _sid) {
    if (!semotus.currentSession) {
        return null;
    }
    return semotus.sessions[semotus.currentSession];
}
exports.get = get;
/**
 * Indicate that all changes have been accepted outside of the message
 * mechanism as would usually happen when a session is starting up
 *
 * @param semotus
 * @param {unknown} sessionId unknown
 */
function sync(semotus, sessionId) {
    get(semotus, sessionId);
    semotus.getChanges();
    semotus._deleteChanges();
}
exports.sync = sync;
/**
 * Restore session that was potentially serialized/deserialized
 *
 * A revision number is used to determine whether the in-memory copy is good
 *
 * @param semotus
 * @param {unknown} sessionId - the id under which it was created with createSession
 * @param {unknown} savedSession - the POJO version of the session data
 * @param {unknown} sendMessage - new message function to be in effect
 *
 * @returns {Boolean} false means that messages were in flight and a reset is needed
 */
function restore(semotus, sessionId, savedSession, sendMessage) {
    semotus.setSession(sessionId);
    var session = semotus.sessions[sessionId];
    semotus.logger.debug({ component: 'semotus', module: 'restore', activity: 'save' });
    if (session) {
        if (session.savedSessionId == savedSession.revision) {
            return true;
        }
        else {
            delete semotus.sessions[sessionId];
        }
    }
    semotus.sessions[sessionId] = JSON.parse(savedSession.data);
    semotus.sessions[sessionId].sendMessage = sendMessage;
    return savedSession.callCount > 0;
}
exports.restore = restore;
/**
 * Save the session data in a way that can be serialized/de-serialized
 *
 * @param semotus
 * @param {unknown} sessionId unknown
 *
 * @returns {Object} unknown
 */
function save(semotus, sessionId) {
    var session = get(semotus, sessionId);
    session.nextSaveSessionId = session.nextSaveSessionId + 1;
    session.savedSessionId = session.nextSaveSessionId;
    var objects = session.objects;
    session.objects = {};
    var savedSession = {
        callCount: semotus.getPendingCallCount(sessionId),
        revision: session.savedSessionId,
        referenced: new Date().getTime(),
        data: JSON.stringify(session) // All the session data
    };
    session.objects = objects;
    semotus.logger.debug({ component: 'semotus', module: 'save', activity: 'save' });
    return savedSession;
}
exports.save = save;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2Vzc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaGVscGVycy9TZXNzaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBOzs7Ozs7Ozs7R0FTRztBQUVILFNBQWdCLE1BQU0sQ0FBQyxPQUFnQixFQUFFLElBQUksRUFBRSxXQUF3QixFQUFFLFNBQVM7SUFDOUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7UUFDbkIsT0FBTyxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztRQUMvQixPQUFPLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztRQUMxQixPQUFPLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztLQUN6QjtJQUVELElBQUksQ0FBQyxTQUFTLEVBQUU7UUFDWixTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO0tBQ3ZDO0lBRUQsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUU5QixPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHO1FBQzFCLGFBQWEsRUFBRSxFQUFFO1FBQ2pCLFdBQVcsRUFBRSxXQUFXO1FBQ3hCLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxXQUFXO1FBQ2pDLFdBQVcsRUFBRSxFQUFFO1FBQ2Ysa0JBQWtCLEVBQUUsRUFBRTtRQUN0Qix1QkFBdUIsRUFBRSxDQUFDO1FBQzFCLGlCQUFpQixFQUFFLENBQUM7UUFDcEIsY0FBYyxFQUFFLENBQUM7UUFDakIsa0JBQWtCLEVBQUUsQ0FBQztRQUNyQixPQUFPLEVBQUUsRUFBRTtRQUNYLFNBQVMsRUFBRSxDQUFDO1FBQ1osY0FBYyxFQUFFLElBQUksQ0FBQyx1QkFBdUI7S0FDL0MsQ0FBQztJQUVGLElBQUksSUFBSSxZQUFZLEtBQUssRUFBRTtRQUN2QixLQUFLLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFB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aUIsR0FBRyxPQUFPLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0lBQzFELE9BQU8sQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0lBQ25ELElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7SUFDaEMsT0FBTyxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFFckIsSUFBTSxZQUFZLEdBQUc7UUFDakIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUM7UUFDakQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxjQUFjO1FBQ2hDLFVBQVUsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRTtRQUNoQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyx1QkFBdUI7S0FDeEQsQ0FBQztJQUVGLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzFCLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDO0lBRS9FLE9BQU8sWUFBWSxDQUFDO0FBQ3hCLENBQUM7QUFuQkQsb0JBbUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtTYXZlZFNlc3Npb24sIFNlbW90dXMsIFNlbmRNZXNzYWdlLCBTZXNzaW9ufSBmcm9tICcuL1R5cGVzJztcblxuLyoqXG4gKiBPYnRhaW4gYSBzZXNzaW9uIGZvciB0cmFja2luZyBzdWJzY3JpcHRpb25zXG4gKlxuICogQHBhcmFtIHNlbW90dXNcbiAqIEBwYXJhbSB7dW5rbm93bn0gcm9sZSB1bmtub3duXG4gKiBAcGFyYW0ge3Vua25vd259IHNlbmRNZXNzYWdlIHVua25vd25cbiAqIEBwYXJhbSB7dW5rbm93bn0gc2Vzc2lvbklkIHVua25vd25cbiAqXG4gKiBAcmV0dXJucyB7Kn0gdW5rbm93blxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGUoc2Vtb3R1czogU2Vtb3R1cywgcm9sZSwgc2VuZE1lc3NhZ2U6IFNlbmRNZXNzYWdlLCBzZXNzaW9uSWQpOiBhbnkge1xuICAgIGlmICghc2Vtb3R1cy5zZXNzaW9ucykge1xuICAgICAgICBzZW1vdHVzLm5leHRTdWJzY3JpcHRpb25JZCA9IDA7XG4gICAgICAgIHNlbW90dXMubmV4dFNlc3Npb25JZCA9IDE7XG4gICAgICAgIHNlbW90dXMuc2Vzc2lvbnMgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAoIXNlc3Npb25JZCkge1xuICAgICAgICBzZXNzaW9uSWQgPSBzZW1vdHVzLm5leHRTZXNzaW9uSWQrKztcbiAgICB9XG5cbiAgICBzZW1vdHVzLnNldFNlc3Npb24oc2Vzc2lvbklkKTtcblxuICAgIHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSA9IHtcbiAgICAgICAgc3Vic2NyaXB0aW9uczoge30sIC8vIENoYW5nZSBsaXN0ZW5lcnNcbiAgICAgICAgc2VuZE1lc3NhZ2U6IHNlbmRNZXNzYWdlLCAvLyBTZW5kIG1lc3NhZ2UgY2FsbGJhY2tcbiAgICAgICAgc2VuZE1lc3NhZ2VFbmFibGVkOiAhIXNlbmRNZXNzYWdlLFxuICAgICAgICByZW1vdGVDYWxsczogW10sIC8vIFJlbW90ZSBjYWxscyBxdWV1ZWQgdG8gZ28gb3V0XG4gICAgICAgIHBlbmRpbmdSZW1vdGVDYWxsczoge30sIC8vIFJlbW90ZSBjYWxscyB3YWl0aW5nIGZvciByZXNwb25zZVxuICAgICAgICBuZXh0UGVuZGluZ1JlbW90ZUNhbGxJZDogMSxcbiAgICAgICAgbmV4dFNhdmVTZXNzaW9uSWQ6IDEsXG4gICAgICAgIHNhdmVkU2Vzc2lvbklkOiAwLFxuICAgICAgICBuZXh0U3Vic2NyaXB0aW9uSWQ6IDAsXG4gICAgICAgIG9iamVjdHM6IHt9LFxuICAgICAgICBuZXh0T2JqSWQ6IDEsXG4gICAgICAgIGRpc3BlbnNlTmV4dElkOiBudWxsIC8vIEZvcmNlIG5leHQgb2JqZWN0IElkXG4gICAgfTtcblxuICAgIGlmIChyb2xlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgZm9yICh2YXIgaXggPSAwOyBpeCA8IHJvbGUubGVuZ3RoOyArK2l4KSB7XG4gICAgICAgICAgICBzZW1vdHVzLnN1YnNjcmliZShyb2xlW2l4XSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZW1vdHVzLnJvbGUgPSByb2xlWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbW90dXMuc3Vic2NyaWJlKHJvbGUpO1xuICAgICAgICBzZW1vdHVzLnJvbGUgPSByb2xlO1xuICAgIH1cblxuICAgIHJldHVybiBzZXNzaW9uSWQ7XG59XG5cblxuLyoqXG4gKiBSZW1vdmUgdGhlIHNlc3Npb24gZnJvbSB0aGUgc2Vzc2lvbnMgbWFwLCByZWplY3RpbmcgYW55IG91dHN0YW5kaW5nIHByb21pc2VzXG4gKiBXQVJOSU5HOiBBc3luYyBzaWRlIGVmZmVjdHNcbiAqIEBwYXJhbSBzZW1vdHVzXG4gKiBAcGFyYW0ge3Vua25vd259IHNlc3Npb25JZCB1bmtub3duXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmUoc2Vtb3R1czogU2Vtb3R1cywgc2Vzc2lvbklkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICBsZXQgc2Vzc2lvbiA9IGdldChzZW1vdHVzLCBzZXNzaW9uSWQpO1xuXG4gICAgZm9yICh2YXIgY2FsbHMgaW4gc2Vzc2lvbi5yZW1vdGVDYWxscykge1xuICAgICAgICBzZXNzaW9uLnJlbW90ZUNhbGxzW2NhbGxzXS5kZWZlcnJlZC5yZWplY3Qoe2NvZGU6ICdyZXNldCcsIHRleHQ6ICdTZXNzaW9uIHJlc3luY2hyb25pemVkJ30pO1xuICAgIH1cblxuICAgIGlmIChzZW1vdHVzLnNlc3Npb25zW3Nlc3Npb25JZF0pIHtcbiAgICAgICAgZGVsZXRlIHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICB9XG59XG5cbi8qKlxuICogR2V0IHRoZSBjdXJyZW50IHNlc3Npb24gc3RydWN0dXJlXG4gKlxuICogQHJldHVybnMgeyp9IHRoZSBzZXNzaW9uXG4gKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldChzZW1vdHVzOiBTZW1vdHVzLCBfc2lkPyk6IFNlc3Npb24gfCBudWxsIHtcbiAgICBpZiAoIXNlbW90dXMuY3VycmVudFNlc3Npb24pIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBzZW1vdHVzLnNlc3Npb25zW3NlbW90dXMuY3VycmVudFNlc3Npb25dO1xufVxuXG5cbi8qKlxuICogSW5kaWNhdGUgdGhhdCBhbGwgY2hhbmdlcyBoYXZlIGJlZW4gYWNjZXB0ZWQgb3V0c2lkZSBvZiB0aGUgbWVzc2FnZVxuICogbWVjaGFuaXNtIGFzIHdvdWxkIHVzdWFsbHkgaGFwcGVuIHdoZW4gYSBzZXNzaW9uIGlzIHN0YXJ0aW5nIHVwXG4gKlxuICogQHBhcmFtIHNlbW90dXNcbiAqIEBwYXJhbSB7dW5rbm93bn0gc2Vzc2lvbklkIHVua25vd25cbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gc3luYyhzZW1vdHVzOiBTZW1vdHVzLCBzZXNzaW9uSWQpIHtcbiAgICBnZXQoc2Vtb3R1cywgc2Vzc2lvbklkKTtcbiAgICBzZW1vdHVzLmdldENoYW5nZXMoKTtcbiAgICBzZW1vdHVzLl9kZWxldGVDaGFuZ2VzKCk7XG59XG5cblxuLyoqXG4gKiBSZXN0b3JlIHNlc3Npb24gdGhhdCB3YXMgcG90ZW50aWFsbHkgc2VyaWFsaXplZC9kZXNlcmlhbGl6ZWRcbiAqXG4gKiBBIHJldmlzaW9uIG51bWJlciBpcyB1c2VkIHRvIGRldGVybWluZSB3aGV0aGVyIHRoZSBpbi1tZW1vcnkgY29weSBpcyBnb29kXG4gKlxuICogQHBhcmFtIHNlbW90dXNcbiAqIEBwYXJhbSB7dW5rbm93bn0gc2Vzc2lvbklkIC0gdGhlIGlkIHVuZGVyIHdoaWNoIGl0IHdhcyBjcmVhdGVkIHdpdGggY3JlYXRlU2Vzc2lvblxuICogQHBhcmFtIHt1bmtub3dufSBzYXZlZFNlc3Npb24gLSB0aGUgUE9KTyB2ZXJzaW9uIG9mIHRoZSBzZXNzaW9uIGRhdGFcbiAqIEBwYXJhbSB7dW5rbm93bn0gc2VuZE1lc3NhZ2UgLSBuZXcgbWVzc2FnZSBmdW5jdGlvbiB0byBiZSBpbiBlZmZlY3RcbiAqXG4gKiBAcmV0dXJucyB7Qm9vbGVhbn0gZmFsc2UgbWVhbnMgdGhhdCBtZXNzYWdlcyB3ZXJlIGluIGZsaWdodCBhbmQgYSByZXNldCBpcyBuZWVkZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlc3RvcmUoc2Vtb3R1czogU2Vtb3R1cywgc2Vzc2lvbklkLCBzYXZlZFNlc3Npb246IFNhdmVkU2Vzc2lvbiwgc2VuZE1lc3NhZ2U6IFNlbmRNZXNzYWdlKSB7XG4gICAgc2Vtb3R1cy5zZXRTZXNzaW9uKHNlc3Npb25JZCk7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICBzZW1vdHVzLmxvZ2dlci5kZWJ1Zyh7Y29tcG9uZW50OiAnc2Vtb3R1cycsIG1vZHVsZTogJ3Jlc3RvcmUnLCBhY3Rpdml0eTogJ3NhdmUnfSk7XG5cbiAgICBpZiAoc2Vzc2lvbikge1xuICAgICAgICBpZiAoc2Vzc2lvbi5zYXZlZFNlc3Npb25JZCA9PSBzYXZlZFNlc3Npb24ucmV2aXNpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXSA9IEpTT04ucGFyc2Uoc2F2ZWRTZXNzaW9uLmRhdGEpO1xuICAgIHNlbW90dXMuc2Vzc2lvbnNbc2Vzc2lvbklkXS5zZW5kTWVzc2FnZSA9IHNlbmRNZXNzYWdlO1xuXG4gICAgcmV0dXJuIHNhdmVkU2Vzc2lvbi5jYWxsQ291bnQgPiAwO1xufVxuXG4vKipcbiAqIFNhdmUgdGhlIHNlc3Npb24gZGF0YSBpbiBhIHdheSB0aGF0IGNhbiBiZSBzZXJpYWxpemVkL2RlLXNlcmlhbGl6ZWRcbiAqXG4gKiBAcGFyYW0gc2Vtb3R1c1xuICogQHBhcmFtIHt1bmtub3dufSBzZXNzaW9uSWQgdW5rbm93blxuICpcbiAqIEByZXR1cm5zIHtPYmplY3R9IHVua25vd25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNhdmUoc2Vtb3R1czogU2Vtb3R1cywgc2Vzc2lvbklkKTogU2F2ZWRTZXNzaW9uIHtcbiAgICBjb25zdCBzZXNzaW9uID0gZ2V0KHNlbW90dXMsIHNlc3Npb25JZCk7XG5cbiAgICBzZXNzaW9uLm5leHRTYXZlU2Vzc2lvbklkID0gc2Vzc2lvbi5uZXh0U2F2ZVNlc3Npb25JZCArIDE7XG4gICAgc2Vzc2lvbi5zYXZlZFNlc3Npb25JZCA9IHNlc3Npb24ubmV4dFNhdmVTZXNzaW9uSWQ7XG4gICAgY29uc3Qgb2JqZWN0cyA9IHNlc3Npb24ub2JqZWN0cztcbiAgICBzZXNzaW9uLm9iamVjdHMgPSB7fTtcblxuICAgIGNvbnN0IHNhdmVkU2Vzc2lvbiA9IHtcbiAgICAgICAgY2FsbENvdW50OiBzZW1vdHVzLmdldFBlbmRpbmdDYWxsQ291bnQoc2Vzc2lvbklkKSwgLy8gQ2FuJ3QganVzdCByZXN0b3JlIG9uIGFub3RoZXIgc2VydmVyIGFuZCBjYXJyeSBvblxuICAgICAgICByZXZpc2lvbjogc2Vzc2lvbi5zYXZlZFNlc3Npb25JZCwgLy8gVXNlZCB0byBzZWUgaWYgb3VyIG1lbW9yeSBjb3B5IGdvb2QgZW5vdWdoXG4gICAgICAgIHJlZmVyZW5jZWQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCAvLyBVc2VkIGZvciByZWFwaW5nIG9sZCBzZXNzaW9uc1xuICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShzZXNzaW9uKSAvLyBBbGwgdGhlIHNlc3Npb24gZGF0YVxuICAgIH07XG5cbiAgICBzZXNzaW9uLm9iamVjdHMgPSBvYmplY3RzO1xuICAgIHNlbW90dXMubG9nZ2VyLmRlYnVnKHtjb21wb25lbnQ6ICdzZW1vdHVzJywgbW9kdWxlOiAnc2F2ZScsIGFjdGl2aXR5OiAnc2F2ZSd9KTtcblxuICAgIHJldHVybiBzYXZlZFNlc3Npb247XG59XG4iXX0=